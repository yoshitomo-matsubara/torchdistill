

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>torchdistill.losses.mid_level &mdash; torchdistill v1.1.4-dev documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=205dc2f2"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html">
            
              <img src="../../../_static/logo-white.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">üìö Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../package.html">torchdistill API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">üßëüèª‚Äçüíª Research</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmarks.html">Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../projects.html">Projects</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">torchdistill</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content style-external-links">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">torchdistill.losses.mid_level</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for torchdistill.losses.mid_level</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">math</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch</span><span class="w"> </span><span class="kn">import</span> <span class="n">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">torch.nn.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">adaptive_avg_pool2d</span><span class="p">,</span> <span class="n">adaptive_max_pool2d</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="n">cosine_similarity</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_loss_wrapper</span><span class="p">,</span> <span class="n">register_mid_level_loss</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..common.constant</span><span class="w"> </span><span class="kn">import</span> <span class="n">def_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">def_logger</span><span class="o">.</span><span class="n">getChild</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_feature_map</span><span class="p">(</span><span class="n">io_dict</span><span class="p">,</span> <span class="n">feature_map_config</span><span class="p">):</span>
    <span class="n">io_type</span> <span class="o">=</span> <span class="n">feature_map_config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">]</span>
    <span class="n">module_path</span> <span class="o">=</span> <span class="n">feature_map_config</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">io_dict</span><span class="p">[</span><span class="n">module_path</span><span class="p">][</span><span class="n">io_type</span><span class="p">]</span>


<div class="viewcode-block" id="SimpleLossWrapper">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.SimpleLossWrapper">[docs]</a>
<span class="nd">@register_loss_wrapper</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SimpleLossWrapper</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A simple loss wrapper module designed to use low-level loss modules (e.g., loss modules in PyTorch)</span>
<span class="sd">    in torchdistill&#39;s pipelines.</span>

<span class="sd">    :param low_level_loss: low-level loss module e.g., torch.nn.CrossEntropyLoss.</span>
<span class="sd">    :type low_level_loss: nn.Module</span>
<span class="sd">    :param kwargs: kwargs to configure what the wrapper passes ``low_level_loss``.</span>
<span class="sd">    :type kwargs: dict or None</span>

<span class="sd">    .. code-block:: YAML</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`SimpleLossWrapper`.</span>

<span class="sd">        criterion_wrapper:</span>
<span class="sd">          key: &#39;SimpleLossWrapper&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            input:</span>
<span class="sd">              is_from_teacher: False</span>
<span class="sd">              module_path: &#39;.&#39;</span>
<span class="sd">              io: &#39;output&#39;</span>
<span class="sd">            target:</span>
<span class="sd">              uses_label: True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low_level_loss</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low_level_loss</span> <span class="o">=</span> <span class="n">low_level_loss</span>
        <span class="n">input_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_input_from_teacher</span> <span class="o">=</span> <span class="n">input_config</span><span class="p">[</span><span class="s1">&#39;is_from_teacher&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_module_path</span> <span class="o">=</span> <span class="n">input_config</span><span class="p">[</span><span class="s1">&#39;module_path&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span> <span class="o">=</span> <span class="n">input_config</span><span class="p">[</span><span class="s1">&#39;io&#39;</span><span class="p">]</span>
        <span class="n">target_config</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uses_label</span> <span class="o">=</span> <span class="n">target_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses_label&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_target_from_teacher</span> <span class="o">=</span> <span class="n">target_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_from_teacher&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_module_path</span> <span class="o">=</span> <span class="n">target_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;module_path&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="o">=</span> <span class="n">target_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;io&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_value</span><span class="p">(</span><span class="n">io_dict</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">io_dict</span><span class="p">[</span><span class="n">path</span><span class="p">][</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">input_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">teacher_io_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_input_from_teacher</span> <span class="k">else</span> <span class="n">student_io_dict</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">input_module_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_module_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_batch</span> <span class="o">=</span> <span class="n">targets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">teacher_io_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_target_from_teacher</span> <span class="k">else</span> <span class="n">student_io_dict</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">target_module_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_level_loss</span><span class="p">(</span><span class="n">input_batch</span><span class="p">,</span> <span class="n">target_batch</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_level_loss</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>



<div class="viewcode-block" id="DictLossWrapper">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.DictLossWrapper">[docs]</a>
<span class="nd">@register_loss_wrapper</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DictLossWrapper</span><span class="p">(</span><span class="n">SimpleLossWrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A dict-based wrapper module designed to use low-level loss modules (e.g., loss modules in PyTorch)</span>
<span class="sd">    in torchdistill&#39;s pipelines. This is a subclass of :class:`SimpleLossWrapper` and useful for models whose forward</span>
<span class="sd">    output is dict.</span>

<span class="sd">    :param low_level_loss: low-level loss module e.g., torch.nn.CrossEntropyLoss.</span>
<span class="sd">    :type low_level_loss: nn.Module</span>
<span class="sd">    :param weights: dict contains keys that match the model&#39;s output dict keys and corresponding loss weights.</span>
<span class="sd">    :type weights: dict</span>
<span class="sd">    :param kwargs: kwargs to configure what the wrapper passes ``low_level_loss``.</span>
<span class="sd">    :type kwargs: dict or None</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`DictLossWrapper` for deeplabv3_resnet50 in torchvision, whose default output is a dict of outputs from its main and auxiliary branches with keys &#39;out&#39; and &#39;aux&#39; respectively.</span>

<span class="sd">        criterion_wrapper:</span>
<span class="sd">          key: &#39;DictLossWrapper&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            input:</span>
<span class="sd">              is_from_teacher: False</span>
<span class="sd">              module_path: &#39;.&#39;</span>
<span class="sd">              io: &#39;output&#39;</span>
<span class="sd">            target:</span>
<span class="sd">              uses_label: True</span>
<span class="sd">            weights:</span>
<span class="sd">              out: 1.0</span>
<span class="sd">              aux: 0.5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">low_level_loss</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">low_level_loss</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">input_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">teacher_io_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_input_from_teacher</span> <span class="k">else</span> <span class="n">student_io_dict</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">input_module_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_module_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_batch</span> <span class="o">=</span> <span class="n">targets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">target_batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_value</span><span class="p">(</span><span class="n">teacher_io_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_target_from_teacher</span> <span class="k">else</span> <span class="n">student_io_dict</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">target_module_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_key</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">sub_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_level_loss</span><span class="p">(</span><span class="n">input_batch</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">target_batch</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loss</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">sub_loss</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">sub_loss</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; * &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">low_level_loss</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span></div>



<div class="viewcode-block" id="KDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.KDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">KDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">KLDivLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard knowledge distillation (KD) loss module.</span>

<span class="sd">    .. math::</span>

<span class="sd">       L_{KD} = \\alpha \cdot L_{CE} + (1 - \\alpha) \cdot \\tau^2 \cdot L_{KL}</span>

<span class="sd">    Geoffrey Hinton, Oriol Vinyals, Jeff Dean: `&quot;Distilling the Knowledge in a Neural Network&quot; &lt;https://arxiv.org/abs/1503.02531&gt;`_ @ NIPS 2014 Deep Learning and Representation Learning Workshop (2014)</span>

<span class="sd">    :param student_module_path: student model&#39;s logit module path.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s logit module path.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param temperature: hyperparameter :math:`\\tau` to soften class-probability distributions.</span>
<span class="sd">    :type temperature: float</span>
<span class="sd">    :param alpha: balancing factor for :math:`L_{CE}`, cross-entropy.</span>
<span class="sd">    :type alpha: float</span>
<span class="sd">    :param beta: balancing factor (default: :math:`1 - \\alpha`) for :math:`L_{KL}`, KL divergence between class-probability distributions softened by :math:`\\tau`.</span>
<span class="sd">    :type beta: float or None</span>
<span class="sd">    :param reduction: ``reduction`` for KLDivLoss. If ``reduction`` = &#39;batchmean&#39;, CrossEntropyLoss&#39;s ``reduction`` will be &#39;mean&#39;.</span>
<span class="sd">    :type reduction: str or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">student_module_io</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="p">,</span>
                 <span class="n">temperature</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;batchmean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta</span>
        <span class="n">cel_reduction</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;batchmean&#39;</span> <span class="k">else</span> <span class="n">reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">cel_reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_logits</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span>
        <span class="n">teacher_logits</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span>
        <span class="n">soft_loss</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">student_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">teacher_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">soft_loss</span>

        <span class="n">hard_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">student_logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">hard_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">soft_loss</span></div>



<div class="viewcode-block" id="FSPLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.FSPLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FSPLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for the flow of solution procedure (FSP) matrix.</span>

<span class="sd">    Junho Yim, Donggyu Joo, Jihoon Bae, Junmo Kim: `&quot;A Gift From Knowledge Distillation: Fast Optimization, Network Minimization and Transfer Learning&quot; &lt;https://openaccess.thecvf.com/content_cvpr_2017/html/Yim_A_Gift_From_CVPR_2017_paper.html&gt;`_ @ CVPR 2017 (2017)</span>

<span class="sd">    :param fsp_pairs: configuration of teacher-student module pairs to compute the loss for the FSP matrix.</span>
<span class="sd">    :type fsp_pairs: dict</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`FSPLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;FSPLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            fsp_pairs:</span>
<span class="sd">              pair1:</span>
<span class="sd">                teacher_first:</span>
<span class="sd">                  io: &#39;input&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                teacher_second:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                student_first:</span>
<span class="sd">                  io: &#39;input&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                student_second:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair2:</span>
<span class="sd">                teacher_first:</span>
<span class="sd">                  io: &#39;input&#39;</span>
<span class="sd">                  path: &#39;layer2.1&#39;</span>
<span class="sd">                teacher_second:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer2&#39;</span>
<span class="sd">                student_first:</span>
<span class="sd">                  io: &#39;input&#39;</span>
<span class="sd">                  path: &#39;layer2.1&#39;</span>
<span class="sd">                student_second:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer2&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fsp_pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fsp_pairs</span> <span class="o">=</span> <span class="n">fsp_pairs</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_fsp_matrix</span><span class="p">(</span><span class="n">first_feature_map</span><span class="p">,</span> <span class="n">second_feature_map</span><span class="p">):</span>
        <span class="n">first_h</span><span class="p">,</span> <span class="n">first_w</span> <span class="o">=</span> <span class="n">first_feature_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">second_h</span><span class="p">,</span> <span class="n">second_w</span> <span class="o">=</span> <span class="n">second_feature_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">target_h</span><span class="p">,</span> <span class="n">target_w</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">first_h</span><span class="p">,</span> <span class="n">second_h</span><span class="p">),</span> <span class="nb">min</span><span class="p">(</span><span class="n">first_w</span><span class="p">,</span> <span class="n">second_w</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">first_h</span> <span class="o">&gt;</span> <span class="n">target_h</span> <span class="ow">or</span> <span class="n">first_w</span> <span class="o">&gt;</span> <span class="n">target_w</span><span class="p">:</span>
            <span class="n">first_feature_map</span> <span class="o">=</span> <span class="n">adaptive_max_pool2d</span><span class="p">(</span><span class="n">first_feature_map</span><span class="p">,</span> <span class="p">(</span><span class="n">target_h</span><span class="p">,</span> <span class="n">target_w</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">second_h</span> <span class="o">&gt;</span> <span class="n">target_h</span> <span class="ow">or</span> <span class="n">second_w</span> <span class="o">&gt;</span> <span class="n">target_w</span><span class="p">:</span>
            <span class="n">second_feature_map</span> <span class="o">=</span> <span class="n">adaptive_max_pool2d</span><span class="p">(</span><span class="n">second_feature_map</span><span class="p">,</span> <span class="p">(</span><span class="n">target_h</span><span class="p">,</span> <span class="n">target_w</span><span class="p">))</span>

        <span class="n">first_feature_map</span> <span class="o">=</span> <span class="n">first_feature_map</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">second_feature_map</span> <span class="o">=</span> <span class="n">second_feature_map</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">hw</span> <span class="o">=</span> <span class="n">first_feature_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">first_feature_map</span><span class="p">,</span> <span class="n">second_feature_map</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="n">hw</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">fsp_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pair_name</span><span class="p">,</span> <span class="n">pair_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fsp_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">student_first_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student_first&#39;</span><span class="p">])</span>
            <span class="n">student_second_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student_second&#39;</span><span class="p">])</span>
            <span class="n">student_fsp_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_fsp_matrix</span><span class="p">(</span><span class="n">student_first_feature_map</span><span class="p">,</span> <span class="n">student_second_feature_map</span><span class="p">)</span>
            <span class="n">teacher_first_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher_first&#39;</span><span class="p">])</span>
            <span class="n">teacher_second_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher_second&#39;</span><span class="p">])</span>
            <span class="n">teacher_fsp_matrices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_fsp_matrix</span><span class="p">(</span><span class="n">teacher_first_feature_map</span><span class="p">,</span> <span class="n">teacher_second_feature_map</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">pair_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">fsp_loss</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">student_fsp_matrices</span> <span class="o">-</span> <span class="n">teacher_fsp_matrices</span><span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">student_first_feature_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fsp_loss</span> <span class="o">/</span> <span class="n">batch_size</span></div>



<div class="viewcode-block" id="ATLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.ATLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ATLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for attention transfer (AT). Referred to https://github.com/szagoruyko/attention-transfer/blob/master/utils.py</span>

<span class="sd">    Sergey Zagoruyko, Nikos Komodakis: `&quot;Paying More Attention to Attention: Improving the Performance of Convolutional Neural Networks via Attention Transfer&quot; &lt;https://openreview.net/forum?id=Sks9_ajex&gt;`_ @ ICLR 2017 (2017)</span>

<span class="sd">    :param at_pairs: configuration of teacher-student module pairs to compute the loss for attention transfer.</span>
<span class="sd">    :type at_pairs: dict</span>
<span class="sd">    :param mode: reference to follow &#39;paper&#39; or &#39;code&#39;.</span>
<span class="sd">    :type mode: dict</span>

<span class="sd">    .. warning::</span>
<span class="sd">        There is a discrepancy between Eq. (2) in the paper and `the authors&#39; implementation &lt;https://github.com/szagoruyko/attention-transfer/blob/893df5488f93691799f082a70e2521a9dc2ddf2d/utils.py#L18-L23&gt;`_</span>
<span class="sd">        as pointed out in `a paper &lt;https://link.springer.com/chapter/10.1007/978-3-030-76423-4_3&gt;`_ and `an issue at the repository &lt;https://github.com/szagoruyko/attention-transfer/issues/34&gt;`_.</span>
<span class="sd">        Use ``mode`` = &#39;paper&#39; instead of &#39;code&#39; if you want to follow the equations in the paper.</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`ATLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;ATLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            at_pairs:</span>
<span class="sd">              pair1:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer3&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer3&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair2:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer4&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer4&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">            mode: &#39;code&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">at_pairs</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">at_pairs</span> <span class="o">=</span> <span class="n">at_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;paper&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mode `</span><span class="si">{}</span><span class="s1">` is not expected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mode</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">attention_transfer_paper</span><span class="p">(</span><span class="n">feature_map</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">feature_map</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_at_loss_paper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_feature_map</span><span class="p">,</span> <span class="n">teacher_feature_map</span><span class="p">):</span>
        <span class="n">at_student</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_transfer_paper</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">)</span>
        <span class="n">at_teacher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_transfer_paper</span><span class="p">(</span><span class="n">teacher_feature_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">at_student</span> <span class="o">-</span> <span class="n">at_teacher</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">attention_transfer</span><span class="p">(</span><span class="n">feature_map</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">feature_map</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_at_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_feature_map</span><span class="p">,</span> <span class="n">teacher_feature_map</span><span class="p">):</span>
        <span class="n">at_student</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_transfer</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">)</span>
        <span class="n">at_teacher</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_transfer</span><span class="p">(</span><span class="n">teacher_feature_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">at_student</span> <span class="o">-</span> <span class="n">at_teacher</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">at_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pair_name</span><span class="p">,</span> <span class="n">pair_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">at_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">student_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student&#39;</span><span class="p">])</span>
            <span class="n">teacher_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">pair_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;paper&#39;</span><span class="p">:</span>
                <span class="n">at_loss</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_at_loss_paper</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">,</span> <span class="n">teacher_feature_map</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">at_loss</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_at_loss</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">,</span> <span class="n">teacher_feature_map</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">at_loss</span> <span class="o">/</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;paper&#39;</span> <span class="k">else</span> <span class="n">at_loss</span></div>



<div class="viewcode-block" id="PKTLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.PKTLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PKTLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for probabilistic knowledge transfer (PKT). Refactored https://github.com/passalis/probabilistic_kt/blob/master/nn/pkt.py</span>

<span class="sd">    Nikolaos Passalis, Anastasios Tefas: `&quot;Learning Deep Representations with Probabilistic Knowledge Transfer&quot; &lt;https://openaccess.thecvf.com/content_ECCV_2018/html/Nikolaos_Passalis_Learning_Deep_Representations_ECCV_2018_paper.html&gt;`_ @ ECCV 2018 (2018)</span>

<span class="sd">    :param student_module_path: student model&#39;s logit module path.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s logit module path.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param eps: constant to avoid zero division.</span>
<span class="sd">    :type eps: float</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`PKTLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;PKTLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            student_module_path: &#39;fc&#39;</span>
<span class="sd">            student_module_io: &#39;input&#39;</span>
<span class="sd">            teacher_module_path: &#39;fc&#39;</span>
<span class="sd">            teacher_module_io: &#39;input&#39;</span>
<span class="sd">            eps: 0.0000001</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">student_module_io</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.0000001</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cosine_similarity_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_outputs</span><span class="p">,</span> <span class="n">teacher_outputs</span><span class="p">):</span>
        <span class="c1"># Normalize each vector by its norm</span>
        <span class="n">norm_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">student_outputs</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">student_outputs</span> <span class="o">=</span> <span class="n">student_outputs</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">student_outputs</span><span class="p">[</span><span class="n">student_outputs</span> <span class="o">!=</span> <span class="n">student_outputs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">norm_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">teacher_outputs</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="n">teacher_outputs</span> <span class="o">=</span> <span class="n">teacher_outputs</span> <span class="o">/</span> <span class="p">(</span><span class="n">norm_t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span>
        <span class="n">teacher_outputs</span><span class="p">[</span><span class="n">teacher_outputs</span> <span class="o">!=</span> <span class="n">teacher_outputs</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Calculate the cosine similarity</span>
        <span class="n">student_similarity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">student_outputs</span><span class="p">,</span> <span class="n">student_outputs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">teacher_similarity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mm</span><span class="p">(</span><span class="n">teacher_outputs</span><span class="p">,</span> <span class="n">teacher_outputs</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Scale cosine similarity to 0..1</span>
        <span class="n">student_similarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">student_similarity</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">teacher_similarity</span> <span class="o">=</span> <span class="p">(</span><span class="n">teacher_similarity</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># Transform them into probabilities</span>
        <span class="n">student_similarity</span> <span class="o">=</span> <span class="n">student_similarity</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">student_similarity</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">teacher_similarity</span> <span class="o">=</span> <span class="n">teacher_similarity</span> <span class="o">/</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">teacher_similarity</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Calculate the KL-divergence</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">teacher_similarity</span> <span class="o">*</span>
                          <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">teacher_similarity</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">student_similarity</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_penultimate_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span>
        <span class="n">teacher_penultimate_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cosine_similarity_loss</span><span class="p">(</span><span class="n">student_penultimate_outputs</span><span class="p">,</span> <span class="n">teacher_penultimate_outputs</span><span class="p">)</span></div>



<div class="viewcode-block" id="FTLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.FTLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">FTLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for factor transfer (FT). This loss module is used at the 2nd stage of FT method.</span>

<span class="sd">    Jangho Kim, Seonguk Park, Nojun Kwak: `&quot;Paraphrasing Complex Network: Network Compression via Factor Transfer&quot; &lt;https://papers.neurips.cc/paper_files/paper/2018/hash/6d9cb7de5e8ac30bd5e8734bc96a35c1-Abstract.html&gt;`_ @ NeurIPS 2018 (2018)</span>

<span class="sd">    :param p: the order of norm.</span>
<span class="sd">    :type p: int</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>
<span class="sd">    :param paraphraser_path: teacher model&#39;s paraphrase module path.</span>
<span class="sd">    :type paraphraser_path: str</span>
<span class="sd">    :param translator_path: student model&#39;s translator module path.</span>
<span class="sd">    :type translator_path: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`FTLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using auxiliary modules :class:`torchdistill.models.wrapper.Teacher4FactorTransfer` and :class:`torchdistill.models.wrapper.Student4FactorTransfer`.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;FTLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            p: 1</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">            paraphraser_path: &#39;paraphraser&#39;</span>
<span class="sd">            translator_path: &#39;translator&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">paraphraser_path</span><span class="o">=</span><span class="s1">&#39;paraphraser&#39;</span><span class="p">,</span>
                 <span class="n">translator_path</span><span class="o">=</span><span class="s1">&#39;translator&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paraphraser_path</span> <span class="o">=</span> <span class="n">paraphraser_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator_path</span> <span class="o">=</span> <span class="n">translator_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">paraphraser_flat_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">paraphraser_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">translator_flat_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">translator_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm_paraphraser_flat_outputs</span> <span class="o">=</span> <span class="n">paraphraser_flat_outputs</span> <span class="o">/</span> <span class="n">paraphraser_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm_translator_flat_outputs</span> <span class="o">=</span> <span class="n">translator_flat_outputs</span> <span class="o">/</span> <span class="n">translator_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">norm_translator_flat_outputs</span><span class="p">,</span> <span class="n">norm_paraphraser_flat_outputs</span><span class="p">,</span>
                                         <span class="n">reduction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">)</span>
        <span class="n">ft_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_translator_flat_outputs</span> <span class="o">-</span> <span class="n">norm_paraphraser_flat_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ft_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span> <span class="k">else</span> <span class="n">ft_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>



<div class="viewcode-block" id="AltActTransferLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.AltActTransferLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AltActTransferLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for distillation of activation boundaries (DAB). Refactored https://github.com/bhheo/AB_distillation/blob/master/cifar10_AB_distillation.py</span>

<span class="sd">    Byeongho Heo, Minsik Lee, Sangdoo Yun, Jin Young Choi: `&quot;Knowledge Transfer via Distillation of Activation Boundaries Formed by Hidden Neurons&quot; &lt;https://ojs.aaai.org/index.php/AAAI/article/view/4264&gt;`_ @ AAAI 2019 (2019)</span>

<span class="sd">    :param feature_pairs: configuration of teacher-student module pairs to compute the loss for distillation of activation boundaries.</span>
<span class="sd">    :type feature_pairs: dict</span>
<span class="sd">    :param margin: margin.</span>
<span class="sd">    :type margin: float</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`AltActTransferLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Connector4DAB`.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;AltActTransferLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            feature_pairs:</span>
<span class="sd">              pair1:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;connector_dict.connector1&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair2:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer2&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;connector_dict.connector2&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair3:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer3&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;connector_dict.connector3&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair4:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer4&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;connector_dict.connector4&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">            margin: 1.0</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_pairs</span><span class="p">,</span> <span class="n">margin</span><span class="p">,</span> <span class="n">reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span> <span class="o">=</span> <span class="n">feature_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_alt_act_transfer_loss</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">margin</span><span class="p">):</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">((</span><span class="n">source</span> <span class="o">+</span> <span class="n">margin</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">source</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">margin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">target</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="o">+</span>
                <span class="p">(</span><span class="n">source</span> <span class="o">-</span> <span class="n">margin</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="n">source</span> <span class="o">&lt;=</span> <span class="n">margin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">target</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dab_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">pair_name</span><span class="p">,</span> <span class="n">pair_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">student_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student&#39;</span><span class="p">])</span>
            <span class="n">teacher_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">pair_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dab_loss</span> <span class="o">+=</span> \
                <span class="n">factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_alt_act_transfer_loss</span><span class="p">(</span><span class="n">student_feature_map</span><span class="p">,</span> <span class="n">teacher_feature_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">margin</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">batch_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">batch_size</span> <span class="o">=</span> <span class="n">student_feature_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dab_loss</span> <span class="o">/</span> <span class="n">batch_size</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span> <span class="k">else</span> <span class="n">dab_loss</span></div>



<div class="viewcode-block" id="RKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.RKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for relational knowledge distillation (RKD). Refactored https://github.com/lenscloth/RKD/blob/master/metric/loss.py</span>

<span class="sd">    Wonpyo Park, Dongju Kim, Yan Lu, Minsu Cho: `&quot;Relational Knowledge Distillation&quot; &lt;https://openaccess.thecvf.com/content_CVPR_2019/html/Park_Relational_Knowledge_Distillation_CVPR_2019_paper.html&gt;`_ @ CVPR 2019 (2019)</span>

<span class="sd">    :param student_output_path: student module path whose output is used in this loss module.</span>
<span class="sd">    :type student_output_path: str</span>
<span class="sd">    :param teacher_output_path: teacher module path whose output is used in this loss module.</span>
<span class="sd">    :type teacher_output_path: str</span>
<span class="sd">    :param dist_factor: weight on distance-based RKD loss.</span>
<span class="sd">    :type dist_factor: float</span>
<span class="sd">    :param angle_factor: weight on angle-based RKD loss.</span>
<span class="sd">    :type angle_factor: float</span>
<span class="sd">    :param reduction: ``reduction`` for SmoothL1Loss.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`RKDLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;RKDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            teacher_output_path: &#39;layer4&#39;</span>
<span class="sd">            student_output_path: &#39;layer4&#39;</span>
<span class="sd">            dist_factor: 1.0</span>
<span class="sd">            angle_factor: 2.0</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_output_path</span><span class="p">,</span> <span class="n">teacher_output_path</span><span class="p">,</span> <span class="n">dist_factor</span><span class="p">,</span> <span class="n">angle_factor</span><span class="p">,</span> <span class="n">reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_output_path</span> <span class="o">=</span> <span class="n">student_output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_output_path</span> <span class="o">=</span> <span class="n">teacher_output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist_factor</span> <span class="o">=</span> <span class="n">dist_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_factor</span> <span class="o">=</span> <span class="n">angle_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_l1_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pdist</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
        <span class="n">e_square</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">prod</span> <span class="o">=</span> <span class="n">e</span> <span class="o">@</span> <span class="n">e</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">e_square</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">e_square</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">prod</span><span class="p">)</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">squared</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">sqrt</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">res</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)),</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_rkd_distance_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">teacher_flat_outputs</span><span class="p">,</span> <span class="n">student_flat_outputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">t_d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">teacher_flat_outputs</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mean_td</span> <span class="o">=</span> <span class="n">t_d</span><span class="p">[</span><span class="n">t_d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">t_d</span> <span class="o">=</span> <span class="n">t_d</span> <span class="o">/</span> <span class="n">mean_td</span>

        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">student_flat_outputs</span><span class="p">,</span> <span class="n">squared</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">mean_d</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">/</span> <span class="n">mean_d</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_l1_loss</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t_d</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_rkd_angle_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">teacher_flat_outputs</span><span class="p">,</span> <span class="n">student_flat_outputs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_factor</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_factor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">td</span> <span class="o">=</span> <span class="p">(</span><span class="n">teacher_flat_outputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">teacher_flat_outputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">norm_td</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">td</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">t_angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">norm_td</span><span class="p">,</span> <span class="n">norm_td</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">sd</span> <span class="o">=</span> <span class="p">(</span><span class="n">student_flat_outputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">student_flat_outputs</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">norm_sd</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">s_angle</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">norm_sd</span><span class="p">,</span> <span class="n">norm_sd</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">smooth_l1_loss</span><span class="p">(</span><span class="n">s_angle</span><span class="p">,</span> <span class="n">t_angle</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">teacher_flat_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_output_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">student_flat_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_output_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">rkd_distance_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rkd_distance_loss</span><span class="p">(</span><span class="n">teacher_flat_outputs</span><span class="p">,</span> <span class="n">student_flat_outputs</span><span class="p">)</span>
        <span class="n">rkd_angle_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_rkd_angle_loss</span><span class="p">(</span><span class="n">teacher_flat_outputs</span><span class="p">,</span> <span class="n">student_flat_outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_factor</span> <span class="o">*</span> <span class="n">rkd_distance_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_factor</span> <span class="o">*</span> <span class="n">rkd_angle_loss</span></div>



<div class="viewcode-block" id="VIDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.VIDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VIDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for variational information distillation (VID). Referred to https://github.com/HobbitLong/RepDistiller/blob/master/distiller_zoo/VID.py</span>

<span class="sd">    Sungsoo Ahn, Shell Xu Hu, Andreas Damianou, Neil D. Lawrence, Zhenwen Dai: `&quot;Variational Information Distillation for Knowledge Transfer&quot; &lt;https://openaccess.thecvf.com/content_CVPR_2019/html/Ahn_Variational_Information_Distillation_for_Knowledge_Transfer_CVPR_2019_paper.html&gt;`_ @ CVPR 2019 (2019)</span>

<span class="sd">    :param feature_pairs: configuration of teacher-student module pairs to compute the loss for variational information distillation.</span>
<span class="sd">    :type feature_pairs: dict</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`VIDLoss` for a teacher-student pair of ResNet-50 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.VariationalDistributor4VID` for the student model.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;VIDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            feature_pairs:</span>
<span class="sd">              pair1:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer1&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;regressor_dict.regressor1&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair2:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer2&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;regressor_dict.regressor2&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair3:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer3&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;regressor_dict.regressor3&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">              pair4:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer4&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;regressor_dict.regressor4&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">            margin: 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span> <span class="o">=</span> <span class="n">feature_pairs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">vid_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pair_name</span><span class="p">,</span> <span class="n">pair_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">pred_mean</span><span class="p">,</span> <span class="n">pred_var</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student&#39;</span><span class="p">])</span>
            <span class="n">teacher_feature_map</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">pair_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">neg_log_prob</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">pred_mean</span> <span class="o">-</span> <span class="n">teacher_feature_map</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">pred_var</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">pred_var</span><span class="p">))</span>
            <span class="n">vid_loss</span> <span class="o">+=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">neg_log_prob</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">vid_loss</span></div>



<div class="viewcode-block" id="CCKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.CCKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CCKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for correlation congruence for knowledge distillation (CCKD).</span>

<span class="sd">    Baoyun Peng, Xiao Jin, Jiaheng Liu, Dongsheng Li, Yichao Wu, Yu Liu, Shunfeng Zhou, Zhaoning Zhang: `&quot;Correlation Congruence for Knowledge Distillation&quot; &lt;https://openaccess.thecvf.com/content_ICCV_2019/html/Peng_Correlation_Congruence_for_Knowledge_Distillation_ICCV_2019_paper.html&gt;`_ @ ICCV 2019 (2019)</span>

<span class="sd">    :param student_linear_path: student model&#39;s linear module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Linear4CCKD`.</span>
<span class="sd">    :type student_linear_path: str</span>
<span class="sd">    :param teacher_linear_path: teacher model&#39;s linear module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Linear4CCKD`.</span>
<span class="sd">    :type teacher_linear_path: str</span>
<span class="sd">    :param kernel_config: kernel (&#39;gaussian&#39; or &#39;bilinear&#39;) configuration.</span>
<span class="sd">    :type kernel_config: dict</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`CCKDLoss` for a teacher-student pair of ResNet-50 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Linear4CCKD` for the teacher and student models.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;CCKDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            teacher_linear_path: &#39;linear&#39;</span>
<span class="sd">            student_linear_path: &#39;linear&#39;</span>
<span class="sd">            kernel_params:</span>
<span class="sd">              key: &#39;gaussian&#39;</span>
<span class="sd">              gamma: 0.4</span>
<span class="sd">              max_p: 2</span>
<span class="sd">            reduction: &#39;batchmean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_linear_path</span><span class="p">,</span> <span class="n">teacher_linear_path</span><span class="p">,</span> <span class="n">kernel_config</span><span class="p">,</span> <span class="n">reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_linear_path</span> <span class="o">=</span> <span class="n">student_linear_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_path</span> <span class="o">=</span> <span class="n">teacher_linear_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="o">=</span> <span class="n">kernel_config</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">kernel_config</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">=</span> <span class="n">kernel_config</span><span class="p">[</span><span class="s1">&#39;max_p&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bilinear&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;self.kernel_type `</span><span class="si">{}</span><span class="s1">` is not expected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cc_mat_by_bilinear_pool</span><span class="p">(</span><span class="n">linear_outputs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">linear_outputs</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">linear_outputs</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cc_mat_by_gaussian_rbf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linear_outputs</span><span class="p">):</span>
        <span class="n">row_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">linear_output</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">linear_outputs</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">right_term</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">linear_output</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">linear_outputs</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">left_term</span> <span class="o">=</span> <span class="p">((</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="n">left_term</span> <span class="o">*</span> <span class="p">(</span><span class="n">right_term</span> <span class="o">**</span> <span class="n">p</span><span class="p">)</span>

            <span class="n">row</span> <span class="o">*=</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">row_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">row_list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">teacher_linear_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">student_linear_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_linear_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">teacher_linear_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="o">==</span> <span class="s1">&#39;bilinear&#39;</span><span class="p">:</span>
            <span class="n">teacher_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cc_mat_by_bilinear_pool</span><span class="p">(</span><span class="n">teacher_linear_outputs</span><span class="p">)</span>
            <span class="n">student_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cc_mat_by_bilinear_pool</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span> <span class="o">==</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">:</span>
            <span class="n">teacher_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cc_mat_by_gaussian_rbf</span><span class="p">(</span><span class="n">teacher_linear_outputs</span><span class="p">)</span>
            <span class="n">student_cc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cc_mat_by_gaussian_rbf</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;self.kernel_type `</span><span class="si">{}</span><span class="s1">` is not expected&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kernel_type</span><span class="p">))</span>

        <span class="n">cc_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">student_cc</span><span class="p">,</span> <span class="n">teacher_cc</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cc_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;batchmean&#39;</span> <span class="k">else</span> <span class="n">cc_loss</span></div>



<div class="viewcode-block" id="SPKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.SPKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SPKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for similarity-preserving knowledge distillation (SPKD).</span>

<span class="sd">    Frederick Tung, Greg Mori: `&quot;Similarity-Preserving Knowledge Distillation&quot; &lt;https://openaccess.thecvf.com/content_ICCV_2019/html/Tung_Similarity-Preserving_Knowledge_Distillation_ICCV_2019_paper.html&gt;`_ @ ICCV2019 (2019)</span>

<span class="sd">    :param student_output_path: student module path whose output is used in this loss module.</span>
<span class="sd">    :type student_output_path: str</span>
<span class="sd">    :param teacher_output_path: teacher module path whose output is used in this loss module.</span>
<span class="sd">    :type teacher_output_path: str</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`SPKDLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;SPKDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            teacher_output_path: &#39;layer4&#39;</span>
<span class="sd">            student_output_path: &#39;layer4&#39;</span>
<span class="sd">            reduction: &#39;batchmean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_output_path</span><span class="p">,</span> <span class="n">teacher_output_path</span><span class="p">,</span> <span class="n">reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_output_path</span> <span class="o">=</span> <span class="n">student_output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_output_path</span> <span class="o">=</span> <span class="n">teacher_output_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">matmul_and_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normalize</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">z</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_spkd_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">teacher_outputs</span><span class="p">,</span> <span class="n">student_outputs</span><span class="p">):</span>
        <span class="n">g_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matmul_and_normalize</span><span class="p">(</span><span class="n">teacher_outputs</span><span class="p">)</span>
        <span class="n">g_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">matmul_and_normalize</span><span class="p">(</span><span class="n">student_outputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">g_t</span> <span class="o">-</span> <span class="n">g_s</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">teacher_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_output_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">student_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_output_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">teacher_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spkd_losses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spkd_loss</span><span class="p">(</span><span class="n">teacher_outputs</span><span class="p">,</span> <span class="n">student_outputs</span><span class="p">)</span>
        <span class="n">spkd_loss</span> <span class="o">=</span> <span class="n">spkd_losses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">spkd_loss</span> <span class="o">/</span> <span class="p">(</span><span class="n">batch_size</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;batchmean&#39;</span> <span class="k">else</span> <span class="n">spkd_loss</span></div>



<div class="viewcode-block" id="CRDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.CRDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CRDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for contrastive representation distillation (CRD). Refactored https://github.com/HobbitLong/RepDistiller/blob/master/crd/criterion.py</span>

<span class="sd">    Yonglong Tian, Dilip Krishnan, Phillip Isola: `&quot;Contrastive Representation Distillation&quot; &lt;https://openreview.net/forum?id=SkgpBJrtvS&gt;`_ @ ICLR 2020 (2020)</span>

<span class="sd">    :param student_norm_module_path: student model&#39;s normalizer module path (:class:`torchdistill.models.wrapper.Normalizer4CRD` in an auxiliary wrapper :class:`torchdistill.models.wrapper.Linear4CRD`).</span>
<span class="sd">    :type student_norm_module_path: str</span>
<span class="sd">    :param student_empty_module_path: student model&#39;s empty module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Linear4CRD`.</span>
<span class="sd">    :type student_empty_module_path: str</span>
<span class="sd">    :param teacher_norm_module_path: teacher model&#39;s normalizer module path (:class:`torchdistill.models.wrapper.Normalizer4CRD` in an auxiliary wrapper :class:`torchdistill.models.wrapper.Linear4CRD`).</span>
<span class="sd">    :type teacher_norm_module_path: str</span>
<span class="sd">    :param input_size: number of input features.</span>
<span class="sd">    :type input_size: int</span>
<span class="sd">    :param output_size: number of output features.</span>
<span class="sd">    :type output_size: int</span>
<span class="sd">    :param num_negative_samples: number of negative samples.</span>
<span class="sd">    :type num_negative_samples: int</span>
<span class="sd">    :param num_samples: number of samples.</span>
<span class="sd">    :type num_samples: int</span>
<span class="sd">    :param temperature: temperature to adjust concentration level (not the temperature for :class:`KDLoss`).</span>
<span class="sd">    :type temperature: float</span>
<span class="sd">    :param momentum: momentum.</span>
<span class="sd">    :type momentum: float</span>
<span class="sd">    :param eps: eps.</span>
<span class="sd">    :type eps: float</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`CRDLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Linear4CRD` for the teacher and student models.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;CRDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            teacher_norm_module_path: &#39;normalizer&#39;</span>
<span class="sd">            student_norm_module_path: &#39;normalizer&#39;</span>
<span class="sd">            student_empty_module_path: &#39;empty&#39;</span>
<span class="sd">            input_size: *feature_dim</span>
<span class="sd">            output_size: &amp;num_samples 1281167</span>
<span class="sd">            num_negative_samples: *num_negative_samples</span>
<span class="sd">            num_samples: *num_samples</span>
<span class="sd">            temperature: 0.07</span>
<span class="sd">            momentum: 0.5</span>
<span class="sd">            eps: 0.0000001</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_prob_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">probs</span><span class="o">.</span><span class="n">div_</span><span class="p">(</span><span class="n">probs</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="n">k</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># Sort the data into the outcomes with probabilities</span>
        <span class="c1"># that are larger and smaller than 1/K.</span>
        <span class="n">smaller</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">larger</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">kk</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">probs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span> <span class="o">*</span> <span class="n">prob</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">smaller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">larger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kk</span><span class="p">)</span>

        <span class="c1"># Loop though and create little binary mixtures that</span>
        <span class="c1"># appropriately allocate the larger outcomes over the</span>
        <span class="c1"># overall uniform mixture.</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">smaller</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">larger</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">small</span> <span class="o">=</span> <span class="n">smaller</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">large</span> <span class="o">=</span> <span class="n">larger</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="p">[</span><span class="n">small</span><span class="p">]</span> <span class="o">=</span> <span class="n">large</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">small</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="p">[</span><span class="n">large</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
                <span class="n">smaller</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">large</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">larger</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">large</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">last_one</span> <span class="ow">in</span> <span class="n">smaller</span> <span class="o">+</span> <span class="n">larger</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">[</span><span class="n">last_one</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_norm_module_path</span><span class="p">,</span> <span class="n">student_empty_module_path</span><span class="p">,</span> <span class="n">teacher_norm_module_path</span><span class="p">,</span>
                 <span class="n">input_size</span><span class="p">,</span> <span class="n">output_size</span><span class="p">,</span> <span class="n">num_negative_samples</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.07</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_norm_module_path</span> <span class="o">=</span> <span class="n">student_norm_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_empty_module_path</span> <span class="o">=</span> <span class="n">student_empty_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_norm_module_path</span> <span class="o">=</span> <span class="n">teacher_norm_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unigrams</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">output_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_negative_samples</span> <span class="o">=</span> <span class="n">num_negative_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span> <span class="o">=</span> <span class="n">num_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">num_negative_samples</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">momentum</span><span class="p">]))</span>
        <span class="n">stdv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">input_size</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;memory_v1&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdv</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s1">&#39;memory_v2&#39;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">output_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">stdv</span><span class="p">)</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="o">-</span><span class="n">stdv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_prob_alias</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unigrams</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="c1"># Draw n samples from multinomial</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">kk</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">long</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">prob</span><span class="o">.</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="n">random_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
        <span class="n">alias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">kk</span><span class="p">)</span>
        <span class="c1"># b is whether a random number is greater than q</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bernoulli</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        <span class="n">oq</span> <span class="o">=</span> <span class="n">kk</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>
        <span class="n">oj</span> <span class="o">=</span> <span class="n">alias</span><span class="o">.</span><span class="n">mul</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">oq</span> <span class="o">+</span> <span class="n">oj</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">contrast_memory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_embed</span><span class="p">,</span> <span class="n">teacher_embed</span><span class="p">,</span> <span class="n">pos_indices</span><span class="p">,</span> <span class="n">contrast_idx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">param_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">param_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">z_v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">z_v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">momentum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">student_embed</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">output_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_v1</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">input_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memory_v1</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># original score computation</span>
        <span class="k">if</span> <span class="n">contrast_idx</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contrast_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_negative_samples</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">contrast_idx</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">copy_</span><span class="p">(</span><span class="n">pos_indices</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># sample</span>
        <span class="n">weight_v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">contrast_idx</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">weight_v1</span> <span class="o">=</span> <span class="n">weight_v1</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">param_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>
        <span class="n">out_v2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">weight_v1</span><span class="p">,</span> <span class="n">teacher_embed</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">out_v2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out_v2</span><span class="p">,</span> <span class="n">param_t</span><span class="p">))</span>
        <span class="c1"># sample</span>
        <span class="n">weight_v2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_v2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">contrast_idx</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="n">weight_v2</span> <span class="o">=</span> <span class="n">weight_v2</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">param_k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">input_size</span><span class="p">)</span>
        <span class="n">out_v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">weight_v2</span><span class="p">,</span> <span class="n">student_embed</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">input_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">out_v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out_v1</span><span class="p">,</span> <span class="n">param_t</span><span class="p">))</span>

        <span class="c1"># set z if haven&#39;t been set yet</span>
        <span class="k">if</span> <span class="n">z_v1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_v1</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">output_size</span>
            <span class="n">z_v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;normalization constant z_v1 is set to </span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_v1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">z_v2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_v2</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">output_size</span>
            <span class="n">z_v2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;normalization constant z_v2 is set to </span><span class="si">{:.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">z_v2</span><span class="p">))</span>

        <span class="c1"># compute out_v1, out_v2</span>
        <span class="n">out_v1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out_v1</span><span class="p">,</span> <span class="n">z_v1</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>
        <span class="n">out_v2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">out_v2</span><span class="p">,</span> <span class="n">z_v2</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span>

        <span class="c1"># update memory</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">l_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_v1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos_indices</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">l_pos</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span>
            <span class="n">l_pos</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">student_embed</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">momentum</span><span class="p">))</span>
            <span class="n">l_norm</span> <span class="o">=</span> <span class="n">l_pos</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">updated_v1</span> <span class="o">=</span> <span class="n">l_pos</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">l_norm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_v1</span><span class="o">.</span><span class="n">index_copy_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos_indices</span><span class="p">,</span> <span class="n">updated_v1</span><span class="p">)</span>

            <span class="n">ab_pos</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">index_select</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memory_v2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pos_indices</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
            <span class="n">ab_pos</span><span class="o">.</span><span class="n">mul_</span><span class="p">(</span><span class="n">momentum</span><span class="p">)</span>
            <span class="n">ab_pos</span><span class="o">.</span><span class="n">add_</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">teacher_embed</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">momentum</span><span class="p">))</span>
            <span class="n">ab_norm</span> <span class="o">=</span> <span class="n">ab_pos</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">updated_v2</span> <span class="o">=</span> <span class="n">ab_pos</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">ab_norm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memory_v2</span><span class="o">.</span><span class="n">index_copy_</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pos_indices</span><span class="p">,</span> <span class="n">updated_v2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_v1</span><span class="p">,</span> <span class="n">out_v2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_contrast_loss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># noise distribution</span>
        <span class="n">pn</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_samples</span><span class="p">)</span>

        <span class="c1"># loss for positive pair</span>
        <span class="n">p_pos</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">log_d1</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">p_pos</span><span class="p">,</span> <span class="n">p_pos</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">pn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span><span class="o">.</span><span class="n">log_</span><span class="p">()</span>

        <span class="c1"># loss for K negative pair</span>
        <span class="n">p_neg</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
        <span class="n">log_d0</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">p_neg</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span><span class="o">.</span><span class="n">fill_</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">pn</span><span class="p">),</span> <span class="n">p_neg</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">m</span> <span class="o">*</span> <span class="n">pn</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span><span class="o">.</span><span class="n">log_</span><span class="p">()</span>

        <span class="n">loss</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">log_d1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">log_d0</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">batch_size</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># pos_idx: the indices of these positive samples in the dataset, size [batch_size]</span>
        <span class="c1"># contrast_idx: the indices of negative samples, size [batch_size, nce_k]</span>
        <span class="n">teacher_linear_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_norm_module_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">student_linear_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_norm_module_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span>
        <span class="n">supp_dict</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_empty_module_path</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
        <span class="n">pos_idx</span><span class="p">,</span> <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">supp_dict</span><span class="p">[</span><span class="s1">&#39;pos_idx&#39;</span><span class="p">],</span> <span class="n">supp_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;contrast_idx&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">student_linear_outputs</span><span class="o">.</span><span class="n">device</span>
        <span class="n">pos_idx</span> <span class="o">=</span> <span class="n">pos_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">contrast_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">contrast_idx</span> <span class="o">=</span> <span class="n">contrast_idx</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">device</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">device</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">probs</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alias</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="n">out_s</span><span class="p">,</span> <span class="n">out_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_memory</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">,</span> <span class="n">teacher_linear_outputs</span><span class="p">,</span> <span class="n">pos_idx</span><span class="p">,</span> <span class="n">contrast_idx</span><span class="p">)</span>
        <span class="n">student_contrast_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_contrast_loss</span><span class="p">(</span><span class="n">out_s</span><span class="p">)</span>
        <span class="n">teacher_contrast_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_contrast_loss</span><span class="p">(</span><span class="n">out_t</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">student_contrast_loss</span> <span class="o">+</span> <span class="n">teacher_contrast_loss</span>
        <span class="k">return</span> <span class="n">loss</span></div>



<div class="viewcode-block" id="AuxSSKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.AuxSSKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AuxSSKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for self-supervision knowledge distillation (SSKD) that treats contrastive prediction as</span>
<span class="sd">    a self-supervision task (auxiliary task). This loss module is used at the 1st stage of SSKD method.</span>
<span class="sd">    Refactored https://github.com/xuguodong03/SSKD/blob/master/student.py</span>

<span class="sd">    Guodong Xu, Ziwei Liu, Xiaoxiao Li, Chen Change Loy: `&quot;Knowledge Distillation Meets Self-Supervision&quot; &lt;https://www.ecva.net/papers/eccv_2020/papers_ECCV/html/898_ECCV_2020_paper.php&gt;`_ @ ECCV 2020 (2020)</span>

<span class="sd">    :param module_path: model&#39;s self-supervision module path.</span>
<span class="sd">    :type module_path: str</span>
<span class="sd">    :param module_io: &#39;input&#39; or &#39;output&#39; of the module in the model.</span>
<span class="sd">    :type module_io: str</span>
<span class="sd">    :param reduction: ``reduction`` for CrossEntropyLoss.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`AuxSSKDLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.SSWrapper4SSKD` for teacher model.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;AuxSSKDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            module_path: &#39;ss_module&#39;</span>
<span class="sd">            module_io: &#39;output&#39;</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_path</span><span class="o">=</span><span class="s1">&#39;ss_module&#39;</span><span class="p">,</span> <span class="n">module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_io</span> <span class="o">=</span> <span class="n">module_io</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ss_module_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">module_io</span><span class="p">]</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="o">.</span><span class="n">device</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">three_forth_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">one_forth_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">three_forth_batch_size</span>
        <span class="n">normal_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">aug_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">normal_rep</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="p">[</span><span class="n">normal_indices</span><span class="p">]</span>
        <span class="n">aug_rep</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="p">[</span><span class="n">aug_indices</span><span class="p">]</span>
        <span class="n">normal_rep</span> <span class="o">=</span> <span class="n">normal_rep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">three_forth_batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">aug_rep</span> <span class="o">=</span> <span class="n">aug_rep</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">one_forth_batch_size</span><span class="p">)</span>
        <span class="n">cos_similarities</span> <span class="o">=</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">aug_rep</span><span class="p">,</span> <span class="n">normal_rep</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">one_forth_batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">targets</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[:</span><span class="n">three_forth_batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">cos_similarities</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span></div>



<div class="viewcode-block" id="SSKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.SSKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SSKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for self-supervision knowledge distillation (SSKD).</span>
<span class="sd">    This loss module is used at the 2nd stage of SSKD method. Refactored https://github.com/xuguodong03/SSKD/blob/master/student.py</span>

<span class="sd">    Guodong Xu, Ziwei Liu, Xiaoxiao Li, Chen Change Loy: `&quot;Knowledge Distillation Meets Self-Supervision&quot; &lt;https://www.ecva.net/papers/eccv_2020/papers_ECCV/html/898_ECCV_2020_paper.php&gt;`_ @ ECCV 2020 (2020)</span>

<span class="sd">    :param student_linear_path: student model&#39;s linear module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.SSWrapper4SSKD`.</span>
<span class="sd">    :type student_linear_path: str</span>
<span class="sd">    :param teacher_linear_path: teacher model&#39;s linear module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.SSWrapper4SSKD`.</span>
<span class="sd">    :type teacher_linear_path: str</span>
<span class="sd">    :param student_ss_module_path: student model&#39;s self-supervision module path.</span>
<span class="sd">    :type student_ss_module_path: str</span>
<span class="sd">    :param teacher_ss_module_path: teacher model&#39;s self-supervision module path.</span>
<span class="sd">    :type teacher_ss_module_path: str</span>
<span class="sd">    :param kl_temp: temperature to soften teacher and student&#39;s class-probability distributions for KL divergence given original data.</span>
<span class="sd">    :type kl_temp: float</span>
<span class="sd">    :param ss_temp: temperature to soften teacher and student&#39;s self-supervision cosine similarities for KL divergence.</span>
<span class="sd">    :type ss_temp: float</span>
<span class="sd">    :param tf_temp: temperature to soften teacher and student&#39;s class-probability distributions for KL divergence given augmented data by transform.</span>
<span class="sd">    :type tf_temp: float</span>
<span class="sd">    :param ss_ratio: ratio of samples with the smallest error levels used for self-supervision.</span>
<span class="sd">    :type ss_ratio: float</span>
<span class="sd">    :param tf_ratio: ratio of samples with the smallest error levels used for transform.</span>
<span class="sd">    :type tf_ratio: float</span>
<span class="sd">    :param student_linear_module_io: &#39;input&#39; or &#39;output&#39; of the linear module in the student model.</span>
<span class="sd">    :type student_linear_module_io: str</span>
<span class="sd">    :param teacher_linear_module_io: &#39;input&#39; or &#39;output&#39; of the linear module in the teacher model.</span>
<span class="sd">    :type teacher_linear_module_io: str</span>
<span class="sd">    :param student_ss_module_io: &#39;input&#39; or &#39;output&#39; of the self-supervision module in the student model.</span>
<span class="sd">    :type student_ss_module_io: str</span>
<span class="sd">    :param teacher_ss_module_io: &#39;input&#39; or &#39;output&#39; of the self-supervision module in the teacher model.</span>
<span class="sd">    :type teacher_ss_module_io: str</span>
<span class="sd">    :param loss_weights: weights for 1) cross-entropy, 2) KL divergence for the original data, 3) KL divergence for self-supervision cosine similarities, and 4) KL divergence for the augmented data by transform.</span>
<span class="sd">    :type loss_weights: list[float] or None</span>
<span class="sd">    :param reduction: ``reduction`` for KLDivLoss. If ``reduction`` = &#39;batchmean&#39;, CrossEntropyLoss&#39;s ``reduction`` will be &#39;mean&#39;.</span>
<span class="sd">    :type reduction: str or None</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`SSKDLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.SSWrapper4SSKD` for the teacher and student models.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;SSKDLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            student_linear_module_path: &#39;model.fc&#39;</span>
<span class="sd">            teacher_linear_module_path: &#39;model.fc&#39;</span>
<span class="sd">            student_ss_module_path: &#39;ss_module&#39;</span>
<span class="sd">            teacher_ss_module_path: &#39;ss_module&#39;</span>
<span class="sd">            kl_temp: 4.0</span>
<span class="sd">            ss_temp: 0.5</span>
<span class="sd">            tf_temp: 4.0</span>
<span class="sd">            ss_ratio: 0.75</span>
<span class="sd">            tf_ratio: 1.0</span>
<span class="sd">            loss_weights: [1.0, 0.9, 10.0, 2.7]</span>
<span class="sd">            reduction: &#39;batchmean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_linear_module_path</span><span class="p">,</span> <span class="n">teacher_linear_module_path</span><span class="p">,</span> <span class="n">student_ss_module_path</span><span class="p">,</span>
                 <span class="n">teacher_ss_module_path</span><span class="p">,</span> <span class="n">kl_temp</span><span class="p">,</span> <span class="n">ss_temp</span><span class="p">,</span> <span class="n">tf_temp</span><span class="p">,</span> <span class="n">ss_ratio</span><span class="p">,</span> <span class="n">tf_ratio</span><span class="p">,</span>
                 <span class="n">student_linear_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">teacher_linear_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                 <span class="n">student_ss_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">teacher_ss_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                 <span class="n">loss_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;batchmean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loss_weights</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span> <span class="k">if</span> <span class="n">loss_weights</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">loss_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kl_temp</span> <span class="o">=</span> <span class="n">kl_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ss_temp</span> <span class="o">=</span> <span class="n">ss_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_temp</span> <span class="o">=</span> <span class="n">tf_temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ss_ratio</span> <span class="o">=</span> <span class="n">ss_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_ratio</span> <span class="o">=</span> <span class="n">tf_ratio</span>
        <span class="n">cel_reduction</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;batchmean&#39;</span> <span class="k">else</span> <span class="n">reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">cel_reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kldiv_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">KLDivLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_path</span> <span class="o">=</span> <span class="n">student_linear_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_io</span> <span class="o">=</span> <span class="n">student_linear_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_path</span> <span class="o">=</span> <span class="n">teacher_linear_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_io</span> <span class="o">=</span> <span class="n">teacher_linear_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_ss_module_path</span> <span class="o">=</span> <span class="n">student_ss_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_ss_module_io</span> <span class="o">=</span> <span class="n">student_ss_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_ss_module_path</span> <span class="o">=</span> <span class="n">teacher_ss_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_ss_module_io</span> <span class="o">=</span> <span class="n">teacher_ss_module_io</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cosine_similarities</span><span class="p">(</span><span class="n">ss_module_outputs</span><span class="p">,</span> <span class="n">normal_indices</span><span class="p">,</span> <span class="n">aug_indices</span><span class="p">,</span>
                                    <span class="n">three_forth_batch_size</span><span class="p">,</span> <span class="n">one_forth_batch_size</span><span class="p">):</span>
        <span class="n">normal_feat</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="p">[</span><span class="n">normal_indices</span><span class="p">]</span>
        <span class="n">aug_feat</span> <span class="o">=</span> <span class="n">ss_module_outputs</span><span class="p">[</span><span class="n">aug_indices</span><span class="p">]</span>
        <span class="n">normal_feat</span> <span class="o">=</span> <span class="n">normal_feat</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">three_forth_batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">aug_feat</span> <span class="o">=</span> <span class="n">aug_feat</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">one_forth_batch_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">aug_feat</span><span class="p">,</span> <span class="n">normal_feat</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_linear_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_io</span><span class="p">]</span>
        <span class="n">teacher_linear_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_io</span><span class="p">]</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">student_linear_outputs</span><span class="o">.</span><span class="n">device</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">student_linear_outputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">three_forth_batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">one_forth_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">three_forth_batch_size</span>
        <span class="n">normal_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">aug_indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">ce_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">[</span><span class="n">normal_indices</span><span class="p">],</span> <span class="n">targets</span><span class="p">)</span>
        <span class="n">kl_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kldiv_loss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">[</span><span class="n">normal_indices</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                  <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">teacher_linear_outputs</span><span class="p">[</span><span class="n">normal_indices</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">kl_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">kl_loss</span> <span class="o">*=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_temp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># error level ranking</span>
        <span class="n">aug_knowledges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">teacher_linear_outputs</span><span class="p">[</span><span class="n">aug_indices</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aug_targets</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aug_targets</span> <span class="o">=</span> <span class="n">aug_targets</span><span class="p">[:</span><span class="n">three_forth_batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">aug_knowledges</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">aug_targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># groundtruth label&#39;s rank</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wrong_num</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="n">correct_num</span> <span class="o">=</span> <span class="n">three_forth_batch_size</span> <span class="o">-</span> <span class="n">wrong_num</span>
        <span class="n">wrong_keep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wrong_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_ratio</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">correct_num</span> <span class="o">+</span> <span class="n">wrong_keep</span><span class="p">]</span>
        <span class="n">distill_index_tf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">indices</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">student_ss_module_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_ss_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_ss_module_io</span><span class="p">]</span>
        <span class="n">teacher_ss_module_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_ss_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_ss_module_io</span><span class="p">]</span>

        <span class="n">s_cos_similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cosine_similarities</span><span class="p">(</span><span class="n">student_ss_module_outputs</span><span class="p">,</span> <span class="n">normal_indices</span><span class="p">,</span>
                                                              <span class="n">aug_indices</span><span class="p">,</span> <span class="n">three_forth_batch_size</span><span class="p">,</span> <span class="n">one_forth_batch_size</span><span class="p">)</span>
        <span class="n">t_cos_similarities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cosine_similarities</span><span class="p">(</span><span class="n">teacher_ss_module_outputs</span><span class="p">,</span> <span class="n">normal_indices</span><span class="p">,</span>
                                                              <span class="n">aug_indices</span><span class="p">,</span> <span class="n">three_forth_batch_size</span><span class="p">,</span> <span class="n">one_forth_batch_size</span><span class="p">)</span>
        <span class="n">t_cos_similarities</span> <span class="o">=</span> <span class="n">t_cos_similarities</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>

        <span class="n">aug_targets</span> <span class="o">=</span> \
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">one_forth_batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">contiguous</span><span class="p">()</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aug_targets</span> <span class="o">=</span> <span class="n">aug_targets</span><span class="p">[:</span><span class="n">three_forth_batch_size</span><span class="p">]</span><span class="o">.</span><span class="n">long</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">t_cos_similarities</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ranks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">aug_targets</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">long</span><span class="p">(),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># groundtruth label&#39;s rank</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">wrong_num</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">numel</span><span class="p">()</span>
        <span class="n">correct_num</span> <span class="o">=</span> <span class="n">three_forth_batch_size</span> <span class="o">-</span> <span class="n">wrong_num</span>
        <span class="n">wrong_keep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">wrong_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss_ratio</span><span class="p">)</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[:</span><span class="n">correct_num</span><span class="o">+</span><span class="n">wrong_keep</span><span class="p">]</span>
        <span class="n">distill_index_ss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">indices</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">ss_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kldiv_loss</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">s_cos_similarities</span><span class="p">[</span><span class="n">distill_index_ss</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                  <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">t_cos_similarities</span><span class="p">[</span><span class="n">distill_index_ss</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ss_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">ss_loss</span> <span class="o">*=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ss_temp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">log_aug_outputs</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">student_linear_outputs</span><span class="p">[</span><span class="n">aug_indices</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_temp</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tf_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kldiv_loss</span><span class="p">(</span><span class="n">log_aug_outputs</span><span class="p">[</span><span class="n">distill_index_tf</span><span class="p">],</span> <span class="n">aug_knowledges</span><span class="p">[</span><span class="n">distill_index_tf</span><span class="p">])</span>
        <span class="n">tf_loss</span> <span class="o">*=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_temp</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">total_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">loss_weight</span><span class="p">,</span> <span class="n">loss</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loss_weights</span><span class="p">,</span> <span class="p">[</span><span class="n">ce_loss</span><span class="p">,</span> <span class="n">kl_loss</span><span class="p">,</span> <span class="n">ss_loss</span><span class="p">,</span> <span class="n">tf_loss</span><span class="p">]):</span>
            <span class="n">total_loss</span> <span class="o">+=</span> <span class="n">loss_weight</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="n">total_loss</span></div>



<div class="viewcode-block" id="PADL2Loss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.PADL2Loss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PADL2Loss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for prime-aware adaptive distillation (PAD) with L2 loss. This loss module is used at the 2nd stage of PAD method.</span>

<span class="sd">    Youcai Zhang, Zhonghao Lan, Yuchen Dai, Fangao Zeng, Yan Bai, Jie Chang, Yichen Wei: `&quot;Prime-Aware Adaptive Distillation&quot; &lt;https://www.ecva.net/papers/eccv_2020/papers_ECCV/html/3317_ECCV_2020_paper.php&gt;`_ @ ECCV 2020 (2020)</span>

<span class="sd">    :param student_embed_module_path: student model&#39;s embedding module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.VarianceBranch4PAD`.</span>
<span class="sd">    :type student_embed_module_path: str</span>
<span class="sd">    :param teacher_embed_module_path: teacher model&#39;s embedding module path.</span>
<span class="sd">    :type teacher_embed_module_path: str</span>
<span class="sd">    :param student_embed_module_io: &#39;input&#39; or &#39;output&#39; of the embedding module in the student model.</span>
<span class="sd">    :type student_embed_module_io: str</span>
<span class="sd">    :param teacher_embed_module_io: &#39;input&#39; or &#39;output&#39; of the embedding module in the teacher model.</span>
<span class="sd">    :type teacher_embed_module_io: str</span>
<span class="sd">    :param module_path: student model&#39;s variance estimator module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.VarianceBranch4PAD`.</span>
<span class="sd">    :type module_path: str</span>
<span class="sd">    :param module_io: &#39;input&#39; or &#39;output&#39; of the variance estimator module in the student model.</span>
<span class="sd">    :type module_io: str</span>
<span class="sd">    :param eps: constant to avoid zero division.</span>
<span class="sd">    :type eps: float</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`PADL2Loss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.VarianceBranch4PAD` for the student model.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;PADL2Loss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            student_embed_module_path: &#39;student_model.avgpool&#39;</span>
<span class="sd">            student_embed_module_io: &#39;output&#39;</span>
<span class="sd">            teacher_embed_module_path: &#39;avgpool&#39;</span>
<span class="sd">            teacher_embed_module_io: &#39;output&#39;</span>
<span class="sd">            module_path: &#39;var_estimator&#39;</span>
<span class="sd">            module_io: &#39;output&#39;</span>
<span class="sd">            eps: 0.000001</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_embed_module_path</span><span class="p">,</span> <span class="n">teacher_embed_module_path</span><span class="p">,</span>
                 <span class="n">student_embed_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">teacher_embed_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span>
                 <span class="n">module_path</span><span class="o">=</span><span class="s1">&#39;var_estimator&#39;</span><span class="p">,</span> <span class="n">module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_embed_module_path</span> <span class="o">=</span> <span class="n">student_embed_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_embed_module_path</span> <span class="o">=</span> <span class="n">teacher_embed_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_embed_module_io</span> <span class="o">=</span> <span class="n">student_embed_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_embed_module_io</span> <span class="o">=</span> <span class="n">teacher_embed_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_io</span> <span class="o">=</span> <span class="n">module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">log_variances</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">module_io</span><span class="p">]</span>
        <span class="n">student_embed_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_embed_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_embed_module_io</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">teacher_embed_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_embed_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_embed_module_io</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># The author&#39;s provided code takes average of losses</span>
        <span class="n">squared_losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="p">(</span><span class="n">teacher_embed_outputs</span> <span class="o">-</span> <span class="n">student_embed_outputs</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_variances</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">log_variances</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">squared_losses</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span> <span class="k">else</span> <span class="n">squared_losses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>



<div class="viewcode-block" id="HierarchicalContextLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.HierarchicalContextLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalContextLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for knowledge review (KR) method. Referred to https://github.com/dvlab-research/ReviewKD/blob/master/ImageNet/models/reviewkd.py</span>

<span class="sd">    Pengguang Chen, Shu Liu, Hengshuang Zhao, Jiaya Jia: `&quot;Distilling Knowledge via Knowledge Review&quot; &lt;https://openaccess.thecvf.com/content/CVPR2021/html/Chen_Distilling_Knowledge_via_Knowledge_Review_CVPR_2021_paper.html&gt;`_ @ CVPR 2021 (2021)</span>

<span class="sd">    :param student_module_path: student model&#39;s module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Student4KnowledgeReview`.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s module path.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param reduction: ``reduction`` for MSELoss.</span>
<span class="sd">    :type reduction: str or None</span>
<span class="sd">    :param output_sizes: output sizes of adaptive_avg_pool2d.</span>
<span class="sd">    :type output_sizes: list[int] or None</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`HierarchicalContextLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Student4KnowledgeReview` for the student model.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;HierarchicalContextLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            student_module_path: &#39;abf_modules.4&#39;</span>
<span class="sd">            student_module_io: &#39;output&#39;</span>
<span class="sd">            teacher_module_path: &#39;layer1.-1.relu&#39;</span>
<span class="sd">            teacher_module_io: &#39;input&#39;</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">            output_sizes: [4, 2, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">student_module_io</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="p">,</span>
                 <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">output_sizes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output_sizes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MSELoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_sizes</span> <span class="o">=</span> <span class="n">output_sizes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_features</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span>
        <span class="n">teacher_features</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">student_features</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">student_features</span><span class="p">,</span> <span class="n">teacher_features</span><span class="p">)</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">total_weight</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;=</span> <span class="n">h</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">proc_student_features</span> <span class="o">=</span> <span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">student_features</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="n">proc_teacher_features</span> <span class="o">=</span> <span class="n">adaptive_avg_pool2d</span><span class="p">(</span><span class="n">teacher_features</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="n">weight</span> <span class="o">/=</span> <span class="mf">2.0</span>
            <span class="n">loss</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">criteria</span><span class="p">(</span><span class="n">proc_student_features</span><span class="p">,</span> <span class="n">proc_teacher_features</span><span class="p">)</span>
            <span class="n">total_weight</span> <span class="o">+=</span> <span class="n">weight</span>
        <span class="k">return</span> <span class="n">loss</span> <span class="o">/</span> <span class="n">total_weight</span></div>



<div class="viewcode-block" id="RegularizationLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.RegularizationLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RegularizationLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A regularization loss module.</span>

<span class="sd">    :param module_path: module path.</span>
<span class="sd">    :type module_path: str</span>
<span class="sd">    :param module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type module_io: str</span>
<span class="sd">    :param is_from_teacher: True if you use teacher&#39;s I/O dict. Otherwise, you use student&#39;s I/O dict.</span>
<span class="sd">    :type is_from_teacher: bool</span>
<span class="sd">    :param p: the order of norm.</span>
<span class="sd">    :type p: int</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_path</span><span class="p">,</span> <span class="n">io_type</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">is_from_teacher</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module_path</span> <span class="o">=</span> <span class="n">module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">io_type</span> <span class="o">=</span> <span class="n">io_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_from_teacher</span> <span class="o">=</span> <span class="n">is_from_teacher</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span> <span class="o">=</span> <span class="n">p</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">io_dict</span> <span class="o">=</span> <span class="n">teacher_io_dict</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_from_teacher</span> <span class="k">else</span> <span class="n">student_io_dict</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">io_type</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">z</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span><span class="p">)</span></div>



<div class="viewcode-block" id="KTALoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.KTALoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">KTALoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for knowledge translation and adaptation (KTA).</span>
<span class="sd">    This loss module is used at the 2nd stage of KTAAD method.</span>

<span class="sd">    Tong He, Chunhua Shen, Zhi Tian, Dong Gong, Changming Sun, Youliang Yan.: `&quot;Knowledge Adaptation for Efficient Semantic Segmentation&quot; &lt;https://openaccess.thecvf.com/content_CVPR_2019/html/He_Knowledge_Adaptation_for_Efficient_Semantic_Segmentation_CVPR_2019_paper.html&gt;`_ @ CVPR 2019 (2019)</span>

<span class="sd">    :param p: the order of norm for differences between normalized feature adapter&#39;s (flattened) output and knowledge translator&#39;s (flattened) output.</span>
<span class="sd">    :type p: int</span>
<span class="sd">    :param q: the order of norm for the denominator to normalize feature adapter (flattened) output.</span>
<span class="sd">    :type q: int</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str</span>
<span class="sd">    :param knowledge_translator_path: knowledge translator module path.</span>
<span class="sd">    :type knowledge_translator_path: str</span>
<span class="sd">    :param feature_adapter_path: feature adapter module path.</span>
<span class="sd">    :type feature_adapter_path: str</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`KTALoss` for a teacher-student pair of DeepLabv3 with ResNet50 and LRASPP with MobileNet v3 (Large) in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Teacher4FactorTransfer` and :class:`torchdistill.models.wrapper.Student4KTAAD` for the teacher and student models.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;KTALoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            p: 1</span>
<span class="sd">            q: 2</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">            knowledge_translator_path: &#39;paraphraser.encoder&#39;</span>
<span class="sd">            feature_adapter_path: &#39;feature_adapter&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">knowledge_translator_path</span><span class="o">=</span><span class="s1">&#39;paraphraser&#39;</span><span class="p">,</span>
                 <span class="n">feature_adapter_path</span><span class="o">=</span><span class="s1">&#39;feature_adapter&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span> <span class="o">=</span> <span class="n">p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">norm_q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knowledge_translator_path</span> <span class="o">=</span> <span class="n">knowledge_translator_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_adapter_path</span> <span class="o">=</span> <span class="n">feature_adapter_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">knowledge_translator_flat_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">knowledge_translator_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">feature_adapter_flat_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">feature_adapter_path</span><span class="p">][</span><span class="s1">&#39;output&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm_knowledge_translator_flat_outputs</span> <span class="o">=</span> \
            <span class="n">knowledge_translator_flat_outputs</span> <span class="o">/</span> \
            <span class="n">knowledge_translator_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_q</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">norm_feature_adapter_flat_outputs</span> <span class="o">=</span> \
            <span class="n">feature_adapter_flat_outputs</span> <span class="o">/</span> <span class="n">feature_adapter_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">norm_q</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">l1_loss</span><span class="p">(</span><span class="n">norm_feature_adapter_flat_outputs</span><span class="p">,</span> <span class="n">norm_knowledge_translator_flat_outputs</span><span class="p">,</span>
                                         <span class="n">reduction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reduction</span><span class="p">)</span>
        <span class="n">kta_loss</span> <span class="o">=</span> \
            <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_feature_adapter_flat_outputs</span> <span class="o">-</span> <span class="n">norm_knowledge_translator_flat_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_p</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kta_loss</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span> <span class="k">else</span> <span class="n">kta_loss</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>



<div class="viewcode-block" id="AffinityLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.AffinityLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AffinityLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for affinity distillation in KTA. This loss module is used at the 2nd stage of KTAAD method.</span>

<span class="sd">    Tong He, Chunhua Shen, Zhi Tian, Dong Gong, Changming Sun, Youliang Yan.: `&quot;Knowledge Adaptation for Efficient Semantic Segmentation&quot; &lt;https://openaccess.thecvf.com/content_CVPR_2019/html/He_Knowledge_Adaptation_for_Efficient_Semantic_Segmentation_CVPR_2019_paper.html&gt;`_ @ CVPR 2019 (2019)</span>

<span class="sd">    :param student_module_path: student model&#39;s module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Student4KTAAD`.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.Teacher4FactorTransfer`.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str or None</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`AffinityLoss` for a teacher-student pair of DeepLabv3 with ResNet50 and LRASPP with MobileNet v3 (Large) in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Teacher4FactorTransfer` and :class:`torchdistill.models.wrapper.Student4KTAAD` for the teacher and student models.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;AffinityLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            student_module_path: &#39;affinity_adapter&#39;</span>
<span class="sd">            student_module_io: &#39;output&#39;</span>
<span class="sd">            teacher_module_path: &#39;paraphraser.encoder&#39;</span>
<span class="sd">            teacher_module_io: &#39;output&#39;</span>
<span class="sd">            reduction: &#39;mean&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span>
                 <span class="n">student_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_flat_outputs</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">teacher_flat_outputs</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">batch_size</span><span class="p">,</span> <span class="n">ch_size</span><span class="p">,</span> <span class="n">hw</span> <span class="o">=</span> <span class="n">student_flat_outputs</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">student_flat_outputs</span> <span class="o">=</span> <span class="n">student_flat_outputs</span> <span class="o">/</span> <span class="n">student_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">teacher_flat_outputs</span> <span class="o">=</span> <span class="n">teacher_flat_outputs</span> <span class="o">/</span> <span class="n">teacher_flat_outputs</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">total_squared_losses</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">student_flat_outputs</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ch_size</span><span class="p">):</span>
            <span class="n">total_squared_losses</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">student_flat_outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">student_flat_outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
                 <span class="o">-</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">teacher_flat_outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">teacher_flat_outputs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="o">/</span> <span class="n">hw</span>
            <span class="p">)</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">total_squared_losses</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span> <span class="k">else</span> <span class="n">total_squared_losses</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>



<div class="viewcode-block" id="ChSimLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.ChSimLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ChSimLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for Inter-Channel Correlation for Knowledge Distillation (ICKD).</span>
<span class="sd">    Refactored https://github.com/ADLab-AutoDrive/ICKD/blob/main/ImageNet/torchdistill/losses/single.py</span>

<span class="sd">    Li Liu, Qingle Huang, Sihao Lin, Hongwei Xie, Bing Wang, Xiaojun Chang, Xiaodan Liang: `&quot;Inter-Channel Correlation for Knowledge Distillation&quot; &lt;https://openaccess.thecvf.com/content/ICCV2021/html/Liu_Exploring_Inter-Channel_Correlation_for_Diversity-Preserved_Knowledge_Distillation_ICCV_2021_paper.html&gt;`_ @ ICCV 2021 (2021)</span>

<span class="sd">    :param feature_pairs: configuration of teacher-student module pairs to compute the L2 distance between the inter-channel correlation matrices of the student and the teacher.</span>
<span class="sd">    :type feature_pairs: dict</span>

<span class="sd">    .. code-block:: yaml</span>
<span class="sd">       :caption: An example YAML to instantiate :class:`ChSimLoss` for a teacher-student pair of ResNet-34 and ResNet-18 in torchvision, using an auxiliary module :class:`torchdistill.models.wrapper.Student4ICKD`.</span>

<span class="sd">        criterion:</span>
<span class="sd">          key: &#39;ChSimLoss&#39;</span>
<span class="sd">          kwargs:</span>
<span class="sd">            feature_pairs:</span>
<span class="sd">              pair1:</span>
<span class="sd">                teacher:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;layer4&#39;</span>
<span class="sd">                student:</span>
<span class="sd">                  io: &#39;output&#39;</span>
<span class="sd">                  path: &#39;embed_dict.embed1&#39;</span>
<span class="sd">                weight: 1</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span> <span class="o">=</span> <span class="n">feature_pairs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smooth_l1_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">SmoothL1Loss</span><span class="p">()</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">batch_loss</span><span class="p">(</span><span class="n">f_s</span><span class="p">,</span> <span class="n">f_t</span><span class="p">):</span>
        <span class="n">bsz</span><span class="p">,</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">f_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">f_s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">f_s</span> <span class="o">=</span> <span class="n">f_s</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">f_t</span> <span class="o">=</span> <span class="n">f_t</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="n">ch</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">emd_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">f_s</span><span class="p">,</span> <span class="n">f_s</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">emd_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">emd_s</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">emd_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">bmm</span><span class="p">(</span><span class="n">f_t</span><span class="p">,</span> <span class="n">f_t</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">emd_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">emd_t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">g_diff</span> <span class="o">=</span> <span class="n">emd_s</span> <span class="o">-</span> <span class="n">emd_t</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="p">(</span><span class="n">g_diff</span> <span class="o">*</span> <span class="n">g_diff</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">bsz</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">ch</span> <span class="o">*</span> <span class="n">bsz</span> <span class="o">*</span> <span class="n">bsz</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">chsim_loss</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">pair_name</span><span class="p">,</span> <span class="n">pair_config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_pairs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">teacher_outputs</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;teacher&#39;</span><span class="p">])</span>
            <span class="n">student_outputs</span> <span class="o">=</span> <span class="n">_extract_feature_map</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">pair_config</span><span class="p">[</span><span class="s1">&#39;student&#39;</span><span class="p">])</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="n">pair_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_loss</span><span class="p">(</span><span class="n">student_outputs</span><span class="p">,</span> <span class="n">teacher_outputs</span><span class="p">)</span>
            <span class="n">chsim_loss</span> <span class="o">+=</span> <span class="n">weight</span> <span class="o">*</span> <span class="n">loss</span>
        <span class="k">return</span> <span class="n">chsim_loss</span></div>



<div class="viewcode-block" id="DISTLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.DISTLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DISTLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for Knowledge Distillation from A Stronger Teacher (DIST).</span>
<span class="sd">    Referred to https://github.com/hunto/image_classification_sota/blob/main/lib/models/losses/dist_kd.py</span>

<span class="sd">    Tao Huang, Shan You, Fei Wang, Chen Qian, Chang Xu: `&quot;Knowledge Distillation from A Stronger Teacher&quot; &lt;https://proceedings.neurips.cc/paper_files/paper/2022/hash/da669dfd3c36c93905a17ddba01eef06-Abstract-Conference.html&gt;`_ @ NeurIPS 2022 (2022)</span>

<span class="sd">    :param student_module_path: student model&#39;s logit module path.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s logit module path.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param beta: balancing factor for inter-loss.</span>
<span class="sd">    :type beta: float</span>
<span class="sd">    :param gamma: balancing factor for intra-loss.</span>
<span class="sd">    :type gamma: float</span>
<span class="sd">    :param tau: hyperparameter :math:`\\tau` to soften class-probability distributions.</span>
<span class="sd">    :type tau: float</span>
<span class="sd">    :param eps: small value to avoid division by zero in cosine simularity.</span>
<span class="sd">    :type eps: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">student_module_io</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="p">,</span>
                 <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pearson_correlation</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">y_s</span> <span class="o">-</span> <span class="n">y_s</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">y_t</span> <span class="o">-</span> <span class="n">y_t</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inter_class_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pearson_correlation</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">intra_class_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_class_relation</span><span class="p">(</span><span class="n">y_s</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">y_t</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_logits</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span>
        <span class="n">teacher_logits</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span>
        <span class="n">y_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">student_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">y_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">teacher_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">inter_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_class_relation</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">)</span>
        <span class="n">intra_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">intra_class_relation</span><span class="p">(</span><span class="n">y_s</span><span class="p">,</span> <span class="n">y_t</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="n">inter_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">*</span> <span class="n">intra_loss</span>
        <span class="k">return</span> <span class="n">loss</span></div>



<div class="viewcode-block" id="SRDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.SRDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SRDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for Understanding the Role of the Projector in Knowledge Distillation.</span>
<span class="sd">    Referred to https://github.com/roymiles/Simple-Recipe-Distillation/blob/main/imagenet/torchdistill/losses/single.py</span>

<span class="sd">    Roy Miles, Krystian Mikolajczyk: `&quot;Understanding the Role of the Projector in Knowledge Distillation&quot; &lt;https://arxiv.org/abs/2303.11098&gt;`_ @ AAAI 2024 (2024)</span>

<span class="sd">    :param student_feature_module_path: student model&#39;s feature module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.SRDModelWrapper`.</span>
<span class="sd">    :type student_feature_module_path: str</span>
<span class="sd">    :param student_feature_module_io: &#39;input&#39; or &#39;output&#39; of the feature module in the student model.</span>
<span class="sd">    :type student_feature_module_io: str</span>
<span class="sd">    :param teacher_feature_module_path: teacher model&#39;s feature module path in an auxiliary wrapper :class:`torchdistill.models.wrapper.SRDModelWrapper`.</span>
<span class="sd">    :type teacher_feature_module_path: str</span>
<span class="sd">    :param teacher_feature_module_io: &#39;input&#39; or &#39;output&#39; of the feature module in the teacher model.</span>
<span class="sd">    :type teacher_feature_module_io: str</span>
<span class="sd">    :param student_linear_module_path: student model&#39;s linear module path.</span>
<span class="sd">    :type student_linear_module_path: str</span>
<span class="sd">    :param student_linear_module_io: &#39;input&#39; or &#39;output&#39; of the linear module in the student model.</span>
<span class="sd">    :type student_linear_module_io: str</span>
<span class="sd">    :param teacher_linear_module_path: teacher model&#39;s linear module path.</span>
<span class="sd">    :type teacher_linear_module_path: str</span>
<span class="sd">    :param teacher_linear_module_io: &#39;input&#39; or &#39;output&#39; of the linear module in the teacher model.</span>
<span class="sd">    :type teacher_linear_module_io: str</span>
<span class="sd">    :param exponent: exponent for feature distillation loss.</span>
<span class="sd">    :type exponent: float</span>
<span class="sd">    :param temperature: hyperparameter :math:`\\tau` to soften class-probability distributions.</span>
<span class="sd">    :type temperature: float</span>
<span class="sd">    :param reduction: loss reduction type.</span>
<span class="sd">    :type reduction: str or None</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_feature_module_path</span><span class="p">,</span> <span class="n">student_feature_module_io</span><span class="p">,</span>
                 <span class="n">teacher_feature_module_path</span><span class="p">,</span> <span class="n">teacher_feature_module_io</span><span class="p">,</span>
                 <span class="n">student_linear_module_path</span><span class="p">,</span> <span class="n">student_linear_module_io</span><span class="p">,</span>
                 <span class="n">teacher_linear_module_path</span><span class="p">,</span> <span class="n">teacher_linear_module_io</span><span class="p">,</span>
                 <span class="n">exponent</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;batchmean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_path</span> <span class="o">=</span> <span class="n">student_feature_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_io</span> <span class="o">=</span> <span class="n">student_feature_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_path</span> <span class="o">=</span> <span class="n">teacher_feature_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_io</span> <span class="o">=</span> <span class="n">teacher_feature_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_path</span> <span class="o">=</span> <span class="n">student_linear_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_io</span> <span class="o">=</span> <span class="n">student_linear_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_path</span> <span class="o">=</span> <span class="n">teacher_linear_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_io</span> <span class="o">=</span> <span class="n">teacher_linear_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exponent</span> <span class="o">=</span> <span class="n">exponent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">KLDivLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_features</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_io</span><span class="p">]</span>
        <span class="n">teacher_features</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_io</span><span class="p">]</span>
        <span class="n">diff_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">student_features</span> <span class="o">-</span> <span class="n">teacher_features</span><span class="p">)</span>
        <span class="n">feat_distill_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">diff_features</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exponent</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

        <span class="n">student_logits</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_linear_module_io</span><span class="p">]</span>
        <span class="n">teacher_logits</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_linear_module_io</span><span class="p">]</span>
        <span class="n">kl_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">criterion</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="n">student_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                 <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">teacher_logits</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">feat_distill_loss</span> <span class="o">+</span> <span class="n">kl_loss</span>
        <span class="k">return</span> <span class="n">loss</span></div>



<div class="viewcode-block" id="LogitStdKDLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.LogitStdKDLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">LogitStdKDLoss</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">KLDivLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A standard knowledge distillation (KD) loss module with logits standardization.</span>

<span class="sd">    Shangquan Sun, Wenqi Ren, Jingzhi Li, Rui Wang, Xiaochun Cao: `&quot;Logit Standardization in Knowledge Distillation&quot; &lt;https://arxiv.org/abs/2403.01427&gt;`_ @ CVPR 2024 (2024)</span>

<span class="sd">    :param student_module_path: student model&#39;s logit module path.</span>
<span class="sd">    :type student_module_path: str</span>
<span class="sd">    :param student_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_module_io: str</span>
<span class="sd">    :param teacher_module_path: teacher model&#39;s logit module path.</span>
<span class="sd">    :type teacher_module_path: str</span>
<span class="sd">    :param teacher_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_module_io: str</span>
<span class="sd">    :param temperature: hyperparameter :math:`\\tau` to soften class-probability distributions.</span>
<span class="sd">    :type temperature: float</span>
<span class="sd">    :param eps: value added to the denominator for numerical stability.</span>
<span class="sd">    :type eps: float</span>
<span class="sd">    :param alpha: balancing factor for :math:`L_{CE}`, cross-entropy.</span>
<span class="sd">    :type alpha: float</span>
<span class="sd">    :param beta: balancing factor (default: :math:`1 - \\alpha`) for :math:`L_{KL}`, KL divergence between class-probability distributions softened by :math:`\\tau`.</span>
<span class="sd">    :type beta: float or None</span>
<span class="sd">    :param reduction: ``reduction`` for KLDivLoss. If ``reduction`` = &#39;batchmean&#39;, CrossEntropyLoss&#39;s ``reduction`` will be &#39;mean&#39;.</span>
<span class="sd">    :type reduction: str or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_module_path</span><span class="p">,</span> <span class="n">student_module_io</span><span class="p">,</span> <span class="n">teacher_module_path</span><span class="p">,</span> <span class="n">teacher_module_io</span><span class="p">,</span>
                 <span class="n">temperature</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s1">&#39;batchmean&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">reduction</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span> <span class="o">=</span> <span class="n">student_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span> <span class="o">=</span> <span class="n">student_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span> <span class="o">=</span> <span class="n">teacher_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span> <span class="o">=</span> <span class="n">teacher_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span> <span class="k">if</span> <span class="n">beta</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">beta</span>
        <span class="n">cel_reduction</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span> <span class="k">if</span> <span class="n">reduction</span> <span class="o">==</span> <span class="s1">&#39;batchmean&#39;</span> <span class="k">else</span> <span class="n">reduction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">CrossEntropyLoss</span><span class="p">(</span><span class="n">reduction</span><span class="o">=</span><span class="n">cel_reduction</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">standardize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">logits</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">logits</span> <span class="o">-</span> <span class="n">logits</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">+</span> <span class="n">logits</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">student_logits</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_module_io</span><span class="p">]</span>
        <span class="n">teacher_logits</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_module_io</span><span class="p">]</span>
        <span class="n">soft_loss</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">student_logits</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                                    <span class="n">torch</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">standardize</span><span class="p">(</span><span class="n">teacher_logits</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">targets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">soft_loss</span>

        <span class="n">hard_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_entropy_loss</span><span class="p">(</span><span class="n">student_logits</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">hard_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">soft_loss</span></div>



<div class="viewcode-block" id="DISTPlusLoss">
<a class="viewcode-back" href="../../../subpkgs/losses.html#torchdistill.losses.mid_level.DISTPlusLoss">[docs]</a>
<span class="nd">@register_mid_level_loss</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DISTPlusLoss</span><span class="p">(</span><span class="n">DISTLoss</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A loss module for DIST+.</span>

<span class="sd">    Tao Huang, Shan You, Fei Wang, Chen Qian, Chang Xu: `&quot;DIST+: Knowledge Distillation From a Stronger Adaptive Teacher&quot; &lt;https://ieeexplore.ieee.org/document/10938241&gt;`_ @ TPAMI (2025)</span>

<span class="sd">    :param student_logit_module_path: student model&#39;s logit module path.</span>
<span class="sd">    :type student_logit_module_path: str</span>
<span class="sd">    :param student_logit_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_logit_module_io: str</span>
<span class="sd">    :param teacher_logit_module_path: teacher model&#39;s logit module path.</span>
<span class="sd">    :type teacher_logit_module_path: str</span>
<span class="sd">    :param teacher_logit_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_logit_module_io: str</span>
<span class="sd">    :param student_feature_module_path: student model&#39;s feature map module path.</span>
<span class="sd">    :type student_feature_module_path: str</span>
<span class="sd">    :param student_feature_module_io: &#39;input&#39; or &#39;output&#39; of the module in the student model.</span>
<span class="sd">    :type student_feature_module_io: str</span>
<span class="sd">    :param teacher_feature_module_path: teacher model&#39;s feature map module path.</span>
<span class="sd">    :type teacher_feature_module_path: str</span>
<span class="sd">    :param teacher_feature_module_io: &#39;input&#39; or &#39;output&#39; of the module in the teacher model.</span>
<span class="sd">    :type teacher_feature_module_io: str</span>
<span class="sd">    :param beta: balancing factor for inter-loss.</span>
<span class="sd">    :type beta: float</span>
<span class="sd">    :param iota: balancing factor for intra-loss.</span>
<span class="sd">    :type iota: float</span>
<span class="sd">    :param kappa: balancing factor for channel relation loss.</span>
<span class="sd">    :type kappa: float</span>
<span class="sd">    :param gamma: balancing factor for spatial relation loss.</span>
<span class="sd">    :type gamma: float</span>
<span class="sd">    :param tau: hyperparameter :math:`\\tau` to soften class-probability distributions.</span>
<span class="sd">    :type tau: float</span>
<span class="sd">    :param eps: small value to avoid division by zero in cosine simularity.</span>
<span class="sd">    :type eps: float</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_logit_module_path</span><span class="p">,</span> <span class="n">student_logit_module_io</span><span class="p">,</span>
                 <span class="n">teacher_logit_module_path</span><span class="p">,</span> <span class="n">teacher_logit_module_io</span><span class="p">,</span>
                 <span class="n">student_feature_module_path</span><span class="p">,</span> <span class="n">student_feature_module_io</span><span class="p">,</span>
                 <span class="n">teacher_feature_module_path</span><span class="p">,</span> <span class="n">teacher_feature_module_io</span><span class="p">,</span>
                 <span class="n">beta</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">iota</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">student_logit_module_path</span><span class="p">,</span> <span class="n">student_logit_module_io</span><span class="p">,</span> <span class="n">teacher_logit_module_path</span><span class="p">,</span> <span class="n">teacher_logit_module_io</span><span class="p">,</span>
            <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="n">eps</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_path</span> <span class="o">=</span> <span class="n">student_feature_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_io</span> <span class="o">=</span> <span class="n">student_feature_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_path</span> <span class="o">=</span> <span class="n">teacher_feature_module_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_io</span> <span class="o">=</span> <span class="n">teacher_feature_module_io</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iota</span> <span class="o">=</span> <span class="n">iota</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">kappa</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">channel_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">f_t</span><span class="p">):</span>
        <span class="n">c_mean_f_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f_s</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">c_mean_f_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">f_t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">c_centered_f_s</span> <span class="o">=</span> <span class="n">f_s</span> <span class="o">-</span> <span class="n">c_mean_f_s</span>
        <span class="n">c_centered_f_t</span> <span class="o">=</span> <span class="n">f_t</span> <span class="o">-</span> <span class="n">c_mean_f_t</span>
        <span class="n">numerator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_centered_f_s</span> <span class="o">*</span> <span class="n">c_centered_f_t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">denominator</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_centered_f_s</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">c_centered_f_t</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">/</span> <span class="p">(</span><span class="n">denominator</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">spatial_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f_s</span><span class="p">,</span> <span class="n">f_t</span><span class="p">):</span>
        <span class="n">aggregated_f_s</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_s</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aggregated_f_t</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">f_t</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">inter_class_relation</span><span class="p">(</span><span class="n">aggregated_f_s</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">aggregated_f_t</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dist_loss</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="n">student_io_dict</span><span class="p">,</span> <span class="n">teacher_io_dict</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">student_features</span> <span class="o">=</span> <span class="n">student_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">student_feature_module_io</span><span class="p">]</span>
        <span class="n">teacher_features</span> <span class="o">=</span> <span class="n">teacher_io_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_path</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher_feature_module_io</span><span class="p">]</span>
        <span class="n">channel_relation_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_relation</span><span class="p">(</span><span class="n">student_features</span><span class="p">,</span> <span class="n">teacher_features</span><span class="p">)</span>
        <span class="n">spatial_relation_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_relation</span><span class="p">(</span><span class="n">student_features</span><span class="p">,</span> <span class="n">teacher_features</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">dist_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">iota</span> <span class="o">*</span> <span class="n">channel_relation_loss</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">spatial_relation_loss</span>
        <span class="k">return</span> <span class="n">loss</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Yoshitomo Matsubara.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LYK8SSJ7R5"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-LYK8SSJ7R5', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>